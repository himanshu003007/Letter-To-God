<!DOCTYPE html>
<html>
<head>
  <title>Group Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chat-box {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      background: #f5f5f5;
    }
    .my-message {
      text-align: right;
      background-color: #dcf8c6;
      margin: 5px;
      padding: 8px;
      border-radius: 10px;
    }
    .other-message {
      text-align: left;
      background-color: #fff;
      margin: 5px;
      padding: 8px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>Group Chat</h2>
  <div id="chat-box"></div>
  <br>
  <input type="text" id="message-input" placeholder="Type your message" style="width: 70%;">
  <button onclick="sendMessage()">Send</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBKlOPu9Z_OdO5hobNTrDLh5rOK_KojZvk",
      authDomain: "private-chats-9203c.firebaseapp.com",
      projectId: "private-chats-9203c",
      storageBucket: "private-chats-9203c.appspot.com",
      messagingSenderId: "421397155816",
      appId: "1:421397155816:web:84b3cdc9218355c34a1e5d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html"; // login page
      } else {
        loadMessages();
      }
    });

    function sendMessage() {
      const messageInput = document.getElementById("message-input");
      const messageText = messageInput.value.trim();
      if (messageText === "") return;

      const user = firebase.auth().currentUser;
      const groupName = localStorage.getItem("joinedGroup");

      db.collection("messages").add({
        text: messageText,
        sender: user.displayName || user.email,
        group: groupName,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        messageInput.value = "";
      }).catch(error => {
        alert("Message not sent: " + error.message);
      });
    }

    function loadMessages() {
      const groupName = localStorage.getItem("joinedGroup");
      db.collection("messages")
        .where("group", "==", groupName)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          const chatBox = document.getElementById("chat-box");
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            const message = doc.data();
            const messageElement = document.createElement("div");
            messageElement.textContent = `${message.sender}: ${message.text}`;
            messageElement.className =
              (firebase.auth().currentUser.displayName === message.sender ||
              firebase.auth().currentUser.email === message.sender)
              ? "my-message"
              : "other-message";
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
          });
        });
    }
  </script>
</body>
</html>
